<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <title>p2p sample</title>
    <style>
        #roomIdInput {
            padding: 10px; width: 200px; margin: 5px;
            border: 2px darkslategray solid;
            border-radius: 10px;
        }

        #videoBox{display:inline-grid;grid-template-columns:repeat(auto-fill,minmax(100%,auto))}
        #videoBox video { width: 100%; }
    </style>
</head>
<body>
    <h3 class="myId"></h3>
    <div>
        <input type="text" name="roomIdInput" id="roomIdInput" placeholder="room id"/>
        <button id="createRoomBtn" disabled>CreateRoom</button>
        <button id="joinRoomBtn" disabled>JoinRoom</button>
        <button id="p2pBtn" disabled>p2p</button>
        <div class="targetId"></div>
    <div id="videoBox"></div>
    
    <div id="printBox"></div>

    <script type="text/javascript" src="https://dev.knowledgetalk.co.kr:7102/knowledgetalk.min.js"></script>
    <script>
        const myId = document.querySelector(".myId");
        const targetId = document.querySelector(".targetId");
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const p2pBtn = document.getElementById('p2pBtn');
        const videoBox = document.getElementById('videoBox');
        const printBox = document.getElementById("printBox")
        
        let knowledgetalk = new Knowledgetalk();
        let cpCode = "KP-20200101-01";
        let authKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoi64Kg66as7KeA7Y-s7J247Yq4IiwibWF4VXNlciI6IjUwMDAwMDAwIiwic3RhcnREYXRlIjoiMjAyMC0wMS0wMVQwNjo0NzowMC4wMDBaIiwiZW5kRGF0ZSI6IjIwMzAtMTItMzFUMDY6NDc6MDAuMDAwWiIsImF1dGhDb2RlIjoiS1AtMjAyMDAxMDEtMDEiLCJjb21wYW55Q29kZSI6IkxJQy0wMSIsImlhdCI6MTU4NzUzODExNH0.73A0UiiMHJeIS8pIgoN4DfEWT4QCsMnXkO4uUdnfbYI";

        let responseSuccessCode = "200";
        let responseSuccessLength = 8;

        const sendVideoType = "cam";
        const presenceEventType = {
            join: "join",
            leave: "leave",
            publish: "publish",
            chat: "chat",
            screen: "screen",
            shareStop: "shareStop",
            subscribed: "subscribed",
        };
        const mediaConfig = {
            video: true,
            audio: false,
        };
    
        let userId = null;
        let members = {};

        // IIFE Initialize
        (async function init() {
            try {
                const initResult = await knowledgetalk.init(cpCode, authKey);
                const initResultCode = initResult.code;
                const initResultUserId = initResult.userId;

                if (initResultCode !== responseSuccessCode || initResultUserId.length < 8) errorHandler("초기화 실패");

                userId = initResultUserId;

                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        })();

        // 방 생성
        async function createRoom() {
            try {
                const createRoomResult = await knowledgetalk.createRoom();
                const createRoomResultCode = createRoomResult.code;
                const createRoomResultLength = createRoomResult.roomId;
                
                if (createRoomResultCode !== responseSuccessCode || createRoomResultLength < responseSuccessLength) errorHandler("초기화 실패");

                const roomId = createRoomResult.roomId;

                roomIdInput.value = roomId;
                createRoomBtn.disabled = true;
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        }
        
        // 방 입장
        async function joinRoom() {
            joinRoomBtn.disabled = true;

            const roomId = roomIdInput.value;

            myId.textContent = userId;

            try {
                const joinRoomResult = await knowledgetalk.joinRoom(roomId);
                const joinRoomResultCode = joinRoomResult.code;

                if (joinRoomResultCode !== responseSuccessCode) errorHandler("방 입장 실패");

                userId = knowledgetalk.getUserId();
                members = joinRoomResult.members;

                for (const member of Object.keys(members)) {
                    if (member !== userId) {
                        targetId.textContent = member;

                        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                        createVideoBox(userId);
                        document.getElementById('multiVideo-' + userId).srcObject = stream;
                    
                        await knowledgetalk.publishP2P(member, 'cam', stream);
                    }
                }
            } catch (err) { 
                console.log(err);
                return alert(err);
            }
        }

        // 비디오 박스 생성
        function createVideoBox(id) {
            let videoContainer = document.createElement('div');
            videoContainer.classList = 'multiVideo';
            videoContainer.id = id;

            let videoLabel = document.createElement("p");
            let videoLabelText = document.createTextNode(id);
            videoLabel.appendChild(videoLabelText);

            videoContainer.appendChild(videoLabel);

            let multiVideo = document.createElement('video');
            multiVideo.autoplay = true;
            multiVideo.playsInline = true;
            multiVideo.id = 'multiVideo-' + id;
            videoContainer.appendChild(multiVideo);

            videoBox.appendChild(videoContainer);
        }

        // 비디오 박스 제거
        function removeVideoBox(id) {
            let child = document.getElementById(id);
            videoBox.removeChild(child);
        }

        // 에러 핸들러
        function errorHandler(cause) {
            throw new Error(cause);
        }
    
        // 리스너
        async function presenceListener(e) {
            const listenerResult = e.detail;
            const { type, user: { id } } = listenerResult;

            switch (type) {
                case presenceEventType.join: {
                    createVideoBox(id);

                    let localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
            createVideoBox(userId);
            document.getElementById('multiVideo-' + userId).srcObject = localStream;

                    break;
                }
                case 'subscribed': {
                    const otherId = listenerResult.user;
                    document.getElementById('multiVideo-' + otherId).srcObject = knowledgetalk.getStream(otherId);
                    break
                }
                case "editUserInfo": {
                    console.log("유저 인포 이벤트 타입 실행");
                }
            }
        }

        createRoomBtn.addEventListener("click", createRoom);
        joinRoomBtn.addEventListener("click", joinRoom);
        knowledgetalk.addEventListener("presence", presenceListener);
    </script>
</body>
</html>