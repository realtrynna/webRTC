<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <title>p2p sample</title>
    <style>
        #roomIdInput {
            padding: 10px; width: 200px; margin: 5px;
            border: 2px darkslategray solid;
            border-radius: 10px;
        }

        #videoBox{display:inline-grid;grid-template-columns:repeat(auto-fill,minmax(100%,auto))}
        #videoBox video { width: 100%; }
    </style>
</head>
<body>
    <div>
        <button class="screenShareStart">화면 공유 시작</button>
        <button class="screenShareStop">화면 공유 중지</button>
    </div>
    <h3 class="currentUserId"></h3>
    <h3 class="currentTargetId"></h3>
    <div>
        <input type="text" name="roomIdInput" id="roomIdInput" placeholder="room id"/>
        <button id="createRoomBtn" disabled>CreateRoom</button>
        <button id="joinRoomBtn" disabled>JoinRoom</button>
        <div class="targetId"></div>

        <div class="wrapper">
            <div class="user-container">닉네임 :</div>
            <div class="display-container">
                <ul class="chatting-list">
                </ul>
            </div>
            <div class="input-container">
                입력<input type="text" class="chatting-input" />
                <button class="send-button">전송</button>
            </div>
        </div>
    <div id="videoBox"></div>
    
    <div id="printBox"></div>

    <script type="text/javascript" src="https://dev.knowledgetalk.co.kr:7102/knowledgetalk.min.js"></script>
    <script>
        const currentUserId = document.querySelector(".currentUserId");
        const currentTargetId = document.querySelector(".currentTargetId");
        const screenShareStartBtn = document.querySelector(".screenShareStart");
        const screenShareStopBtn = document.querySelector(".screenShareStop");
        const sendBtn = document.querySelector('.send-button');
        const chatList = document.querySelector('.chatting-list');
        const chatInput = document.querySelector('.chatting-input');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const p2pBtn = document.getElementById('p2pBtn');
        const videoBox = document.getElementById('videoBox');
        const printBox = document.getElementById("printBox")
        
        let knowledgetalk = new Knowledgetalk();
        let cpCode = "KP-20200101-01";
        let authKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoi64Kg66as7KeA7Y-s7J247Yq4IiwibWF4VXNlciI6IjUwMDAwMDAwIiwic3RhcnREYXRlIjoiMjAyMC0wMS0wMVQwNjo0NzowMC4wMDBaIiwiZW5kRGF0ZSI6IjIwMzAtMTItMzFUMDY6NDc6MDAuMDAwWiIsImF1dGhDb2RlIjoiS1AtMjAyMDAxMDEtMDEiLCJjb21wYW55Q29kZSI6IkxJQy0wMSIsImlhdCI6MTU4NzUzODExNH0.73A0UiiMHJeIS8pIgoN4DfEWT4QCsMnXkO4uUdnfbYI";

        let responseSuccessCode = "200";
        let responseSuccessLength = 8;

        const sendVideoType = "cam";
        const presenceEventType = {
            join: "join",
            leave: "leave",
            publish: "publish",
            chat: "chat",
            screen: "screen",
            shareStop: "shareStop",
            subscribed: "subscribed",
        };
        const mediaConfig = {
            video: true,
            audio: false,
        };
    
        let userId = null;
        let targetId = null;
        let roomId = null;
        let members = {};

        // IIFE Initialize
        (async function init() {
            try {
                const initResult = await knowledgetalk.init(cpCode, authKey);
                const initResultCode = initResult.code;
                const initResultUserId = initResult.userId;

                if (initResultCode !== responseSuccessCode || initResultUserId.length < 8) errorHandler("초기화 실패");

                userId = initResultUserId;

                createRoomBtn.disabled = false;
                joinRoomBtn.disabled = false;
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        })();

        // 방 생성
        async function createRoom() {
            try {
                const createRoomResult = await knowledgetalk.createRoom();
                const createRoomResultCode = createRoomResult.code;
                const createRoomResultLength = createRoomResult.roomId;
                
                if (createRoomResultCode !== responseSuccessCode || createRoomResultLength < responseSuccessLength) errorHandler("초기화 실패");

                roomId = createRoomResult.roomId;

                roomIdInput.value = roomId;
                createRoomBtn.disabled = true;
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        }
        
        // 방 입장
        async function joinRoom() {
            try {   
                const roomId = roomIdInput.value;
                const joinRoomResult = await knowledgetalk.joinRoom(roomId);
                
                currentUserId.textContent = `내 아이디 ${userId}`;
                members = joinRoomResult.members;
                
                // 내 비디오
                createVideoBox(userId);
                const localStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
                document.getElementById(`multiVideo-${userId}`).srcObject = localStream;

                console.log(userId);
                console.log("로컬 스트림");
                console.log(localStream);

                for (const member of Object.keys(members)) {
                    if (member !== userId) {
                        currentTargetId.textContent = `너 아이디 ${member}`;
                    
                        targetId = member;
                    }
                }
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        }

        // 비디오 박스 생성
        function createVideoBox(id) {
            let videoContainer = document.createElement('div');
            videoContainer.classList = 'multiVideo';
            videoContainer.id = id;

            let videoLabel = document.createElement("p");
            let videoLabelText = document.createTextNode(id);
            videoLabel.appendChild(videoLabelText);

            videoContainer.appendChild(videoLabel);

            let multiVideo = document.createElement('video');
            multiVideo.autoplay = true;
            multiVideo.playsInline = true;
            multiVideo.id = 'multiVideo-' + id;
            videoContainer.appendChild(multiVideo);

            videoBox.appendChild(videoContainer);
        }

        // 비디오 박스 제거
        function removeVideoBox(id) {
            let child = document.getElementById(id);
            videoBox.removeChild(child);
        }

        // 메세지 전송
        async function sendMessage() {
            try {
                const message = chatInput.value;

                const li = document.createElement("li");
                li.innerText = `나: ${message}`;
                chatList.appendChild(li);

                const sendMessage = await knowledgetalk.chat(message, roomId, targetId);
                const sendMessageResult = sendMessage.code;

                if (sendMessageResult !== responseSuccessCode) return errorHandler("메세지 전송 실패");
            } catch (err) {
                console.log(err);
                return alert(err);
            }
        }

        // 에러 핸들러
        function errorHandler(cause) {
            throw new Error(cause);
        }
    
        // 화면 공유 시작
        async function screenShareStart() {
            try {
                const screenShareStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                    },
                    audio: false,
                });

                console.log(screenShareStream);                

                document.getElementById(`multiVideo-${userId}`).srcObject = screenShareStream;

                // 스트림 비디오 트랙 정보 추출(onended)
                screenShareStream.getVideoTracks().forEach(track => {
                    // console.log(track);
                    track.onended = () => {
                        screenShareStop();
                    };
                });

                // 송출, 미디어 서버로 영상 송신
                const screenShareStart = await knowledgetalk.screenStart(screenShareStream, targetId);
                const screenShareStartResult = screenShareStart.code;
                
                if (screenShareStartResult !== responseSuccessCode) errorHandler("화면 공유 시작 실패");
            } catch (err) {
                console.error(err);
                return alert(err);
            } 
        }

        // 화면 공유 중지
        async function screenShareStop() {
            try {
                await knowledgetalk.shareStop();

                const screenShareStream = await navigator.mediaDevices.getUserMedia(mediaConfig);
                const screenShareStreamResult = screenShareStream.active;

                if (!screenShareStreamResult) errorHandler("화면 공유 중지 실패");

                document.getElementById(`multiVideo-${userId}`).srcObject = screenShareStream;
            } catch (err) { 
                console.log(err);
                return alert(err);
            }
        }

        // 리스너
        async function presenceListener(e) {
            const listenerResult = e.detail;
            const { type, user: { id } } = listenerResult;

            switch (type) {
                // 입장
                case presenceEventType.join: {
                    currentTargetId.textContent = `너 아이디 ${id}`;

                    const localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                    const localStreamPublish = await knowledgetalk.publishP2P(id, sendVideoType, localStream);

                    console.log(localStream);

                    if (!localStreamPublish) errorHandler("영상 송출 실패");

                    createVideoBox(id);
                    document.getElementById(`multiVideo-${id}`).srcObject = localStream;

                    targetId = id;

                    break;
                }
                
                // 채팅
                case presenceEventType.chat: {
                    const message = listenerResult.message;
                    const messageSendTargetId = listenerResult.user;

                    if (type === presenceEventType.chat) {
                        const li = document.createElement("li");
                        li.innerText = `${messageSendTargetId}: ${message}`;
                        chatList.appendChild(li);
                    }

                    break;
                }
                
                // 수신
                case presenceEventType.subscribed: {
                    const targetId = listenerResult.user;

                    // 화면 공유
                    if (!listenerResult.cam) {
                        // 모든 스트림
                        const getAllStreams = knowledgetalk.getAllStreams();
                        const getStream = knowledgetalk.getStream(targetId);

                        console.log(targetId);
                        console.log(getAllStreams);
                        console.log(getStream);

                        // return document.getElementById(`multiVideo-${listenerResult.user}`).srcObject = getAllStreams;
                    }

                    const targetStream = knowledgetalk.getStream(targetId);

                    createVideoBox(targetId);

                    document.getElementById(`multiVideo-${targetId}`).srcObject = targetStream;
                }
                
                // 공유 중지
                case presenceEventType.shareStop: {
                    if (type === presenceEventType.shareStop) {
                        const screenShareStopTargetId = listenerResult.user;

                        const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                        document.getElementById(`multiVideo-${screenShareStopTargetId}`).srcObject = stream;
                    }
                }
            }
        }

        screenShareStartBtn.addEventListener("click", screenShareStart);
        screenShareStopBtn.addEventListener("click", screenShareStop);
        sendBtn.addEventListener("click", sendMessage);
        createRoomBtn.addEventListener("click", createRoom);
        joinRoomBtn.addEventListener("click", joinRoom);
        knowledgetalk.addEventListener("presence", presenceListener);
    </script>
</body>
</html>